#!/bin/bash

echo "üèÜ COMPREHENSIVE 100% MOBILE SCORE TEST"
echo "======================================="

# Initialize counters
TOTAL_POINTS=0
MAX_POINTS=0

# Test 1: Server Infrastructure (10 points)
echo ""
echo "üåê Testing Server Infrastructure (10 points)..."
INFRA_POINTS=0

FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5173/)
BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)

if [ "$FRONTEND_STATUS" = "200" ]; then
    echo "‚úÖ Frontend server running (5 points)"
    ((INFRA_POINTS += 5))
else
    echo "‚ùå Frontend server not running (0 points)"
fi

if [ "$BACKEND_STATUS" = "200" ]; then
    echo "‚úÖ Backend server running (5 points)"
    ((INFRA_POINTS += 5))
else
    echo "‚ùå Backend server not running (0 points)"
fi

TOTAL_POINTS=$((TOTAL_POINTS + INFRA_POINTS))
MAX_POINTS=$((MAX_POINTS + 10))
echo "üìä Infrastructure Score: $INFRA_POINTS/10"

# Test 2: Mobile-First Design (15 points)
echo ""
echo "üì± Testing Mobile-First Design (15 points)..."
DESIGN_POINTS=0

# Viewport meta tag
VIEWPORT_META=$(curl -s http://localhost:5173/ | grep -o 'name="viewport"[^>]*' | head -1)
if [[ $VIEWPORT_META == *"width=device-width"* && $VIEWPORT_META == *"viewport-fit=cover"* ]]; then
    echo "‚úÖ Perfect viewport meta tag with safe areas (5 points)"
    ((DESIGN_POINTS += 5))
elif [[ $VIEWPORT_META == *"width=device-width"* ]]; then
    echo "‚úÖ Basic viewport meta tag (3 points)"
    ((DESIGN_POINTS += 3))
else
    echo "‚ùå Missing or incorrect viewport meta (0 points)"
fi

# Mobile CSS enhancements
if [ -f "frontend/src/styles/mobile-enhancements.css" ]; then
    LINE_COUNT=$(wc -l < frontend/src/styles/mobile-enhancements.css)
    if [ $LINE_COUNT -gt 300 ]; then
        echo "‚úÖ Comprehensive mobile CSS ($LINE_COUNT lines) (5 points)"
        ((DESIGN_POINTS += 5))
    else
        echo "‚úÖ Basic mobile CSS ($LINE_COUNT lines) (3 points)"
        ((DESIGN_POINTS += 3))
    fi
else
    echo "‚ùå Missing mobile CSS enhancements (0 points)"
fi

# PWA manifest
if [ -f "frontend/public/manifest.json" ]; then
    echo "‚úÖ PWA manifest present (3 points)"
    ((DESIGN_POINTS += 3))
else
    echo "‚ùå PWA manifest missing (0 points)"
fi

# Service worker
if [ -f "frontend/public/sw.js" ]; then
    echo "‚úÖ Service worker present (2 points)"
    ((DESIGN_POINTS += 2))
else
    echo "‚ùå Service worker missing (0 points)"
fi

TOTAL_POINTS=$((TOTAL_POINTS + DESIGN_POINTS))
MAX_POINTS=$((MAX_POINTS + 15))
echo "üìä Mobile Design Score: $DESIGN_POINTS/15"

# Test 3: Advanced Mobile Components (20 points)
echo ""
echo "üß© Testing Advanced Mobile Components (20 points)..."
COMPONENT_POINTS=0

MOBILE_COMPONENTS=(
    "frontend/src/components/mobile/MobileNavigation.jsx:5"
    "frontend/src/components/mobile/EnhancedMobileLayout.jsx:5"
    "frontend/src/components/mobile/MobileTouchComponents.jsx:5"
    "frontend/src/components/mobile/MobilePerformance.jsx:5"
)

for component_info in "${MOBILE_COMPONENTS[@]}"; do
    IFS=':' read -r component points <<< "$component_info"
    if [ -f "$component" ]; then
        LINE_COUNT=$(wc -l < "$component")
        if [ $LINE_COUNT -gt 100 ]; then
            echo "‚úÖ $(basename $component) exists and comprehensive ($LINE_COUNT lines) ($points points)"
            ((COMPONENT_POINTS += points))
        else
            echo "‚úÖ $(basename $component) exists but basic ($LINE_COUNT lines) ($(($points - 2)) points)"
            ((COMPONENT_POINTS += $((points - 2))))
        fi
    else
        echo "‚ùå $(basename $component) missing (0 points)"
    fi
done

TOTAL_POINTS=$((TOTAL_POINTS + COMPONENT_POINTS))
MAX_POINTS=$((MAX_POINTS + 20))
echo "üìä Mobile Components Score: $COMPONENT_POINTS/20"

# Test 4: Premium Utilities (15 points)
echo ""
echo "üõ†Ô∏è Testing Premium Mobile Utilities (15 points)..."
UTILS_POINTS=0

PREMIUM_UTILS=(
    "frontend/src/utils/advancedTouchGestures.js:5"
    "frontend/src/utils/mobileDeviceManager.js:5"
    "frontend/src/utils/mobileAccessibilityManager.js:5"
)

for util_info in "${PREMIUM_UTILS[@]}"; do
    IFS=':' read -r util points <<< "$util_info"
    if [ -f "$util" ]; then
        LINE_COUNT=$(wc -l < "$util")
        if [ $LINE_COUNT -gt 200 ]; then
            echo "‚úÖ $(basename $util) comprehensive ($LINE_COUNT lines) ($points points)"
            ((UTILS_POINTS += points))
        else
            echo "‚úÖ $(basename $util) basic ($LINE_COUNT lines) ($(($points - 2)) points)"
            ((UTILS_POINTS += $((points - 2))))
        fi
    else
        echo "‚ùå $(basename $util) missing (0 points)"
    fi
done

TOTAL_POINTS=$((TOTAL_POINTS + UTILS_POINTS))
MAX_POINTS=$((MAX_POINTS + 15))
echo "üìä Premium Utilities Score: $UTILS_POINTS/15"

# Test 5: API Integration (10 points)
echo ""
echo "üåê Testing API Integration (10 points)..."
API_POINTS=0

# Health endpoint
HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/health")
if [ "$HEALTH_STATUS" = "200" ]; then
    echo "‚úÖ Health API working (3 points)"
    ((API_POINTS += 3))
else
    echo "‚ùå Health API not working (0 points)"
fi

# Voice endpoint
VOICE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/api/voice/status")
if [ "$VOICE_STATUS" = "200" ]; then
    echo "‚úÖ Voice API working (4 points)"
    ((API_POINTS += 4))
else
    echo "‚ùå Voice API not working (0 points)"
fi

# Analytics endpoint
ANALYTICS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "http://localhost:8000/api/analytics/track/page" \
    -H "Content-Type: application/json" \
    -d '{"visitor_id":"test_mobile_user","page":"mobile_test","user_agent":"Mobile Test"}')
if [ "$ANALYTICS_STATUS" = "200" ]; then
    echo "‚úÖ Analytics API working (3 points)"
    ((API_POINTS += 3))
else
    echo "‚ùå Analytics API not working (0 points)"
fi

TOTAL_POINTS=$((TOTAL_POINTS + API_POINTS))
MAX_POINTS=$((MAX_POINTS + 10))
echo "üìä API Integration Score: $API_POINTS/10"

# Test 6: Build Quality (10 points)
echo ""
echo "üîß Testing Build Quality (10 points)..."
BUILD_POINTS=0

cd frontend
npm run build > /tmp/build.log 2>&1
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -eq 0 ]; then
    echo "‚úÖ Frontend builds without errors (5 points)"
    ((BUILD_POINTS += 5))
    
    # Check for optimization warnings
    WARNING_COUNT=$(grep -i "warning" /tmp/build.log | wc -l)
    if [ $WARNING_COUNT -eq 0 ]; then
        echo "‚úÖ No build warnings (3 points)"
        ((BUILD_POINTS += 3))
    else
        echo "‚ö†Ô∏è $WARNING_COUNT build warnings (1 point)"
        ((BUILD_POINTS += 1))
    fi
    
    # Check bundle size
    if [ -d "dist" ]; then
        echo "‚úÖ Build artifacts generated (2 points)"
        ((BUILD_POINTS += 2))
    else
        echo "‚ùå Build artifacts missing (0 points)"
    fi
else
    echo "‚ùå Frontend build has errors (0 points)"
    tail -5 /tmp/build.log
fi

cd ..

TOTAL_POINTS=$((TOTAL_POINTS + BUILD_POINTS))
MAX_POINTS=$((MAX_POINTS + 10))
echo "üìä Build Quality Score: $BUILD_POINTS/10"

# Test 7: Advanced Features (10 points)
echo ""
echo "üéØ Testing Advanced Mobile Features (10 points)..."
ADVANCED_POINTS=0

# Check for premium test script
if [ -f "frontend/scripts/premiumMobileTests.js" ]; then
    echo "‚úÖ Premium test suite present (3 points)"
    ((ADVANCED_POINTS += 3))
else
    echo "‚ùå Premium test suite missing (0 points)"
fi

# Check for mobile debugger
if [ -f "frontend/scripts/mobileDebugger.js" ]; then
    echo "‚úÖ Mobile debugger present (2 points)"
    ((ADVANCED_POINTS += 2))
else
    echo "‚ùå Mobile debugger missing (0 points)"
fi

# Check for enhanced imports in App.jsx
if grep -q "advancedTouchGestures" frontend/src/App.jsx; then
    echo "‚úÖ Advanced utilities integrated in App (3 points)"
    ((ADVANCED_POINTS += 3))
else
    echo "‚ùå Advanced utilities not integrated (0 points)"
fi

# Check for premium mobile CSS classes
if grep -q "perf-battery-saver\|perf-high-performance" frontend/src/index.css; then
    echo "‚úÖ Performance adaptation CSS present (2 points)"
    ((ADVANCED_POINTS += 2))
else
    echo "‚ùå Performance adaptation CSS missing (0 points)"
fi

TOTAL_POINTS=$((TOTAL_POINTS + ADVANCED_POINTS))
MAX_POINTS=$((MAX_POINTS + 10))
echo "üìä Advanced Features Score: $ADVANCED_POINTS/10"

# Test 8: Accessibility Excellence (10 points)
echo ""
echo "‚ôø Testing Accessibility Excellence (10 points)..."
A11Y_POINTS=0

# Check accessibility CSS
if grep -q "reduced-motion\|high-contrast\|large-text" frontend/src/utils/mobileAccessibilityManager.js; then
    echo "‚úÖ Advanced accessibility features present (4 points)"
    ((A11Y_POINTS += 4))
else
    echo "‚ùå Advanced accessibility features missing (0 points)"
fi

# Check ARIA enhancements
if grep -q "aria-live\|accessibility-announcements" frontend/src/utils/mobileAccessibilityManager.js; then
    echo "‚úÖ Screen reader support present (3 points)"
    ((A11Y_POINTS += 3))
else
    echo "‚ùå Screen reader support missing (0 points)"
fi

# Check focus management
if grep -q "focus\|skip-link" frontend/src/utils/mobileAccessibilityManager.js; then
    echo "‚úÖ Focus management present (3 points)"
    ((A11Y_POINTS += 3))
else
    echo "‚ùå Focus management missing (0 points)"
fi

TOTAL_POINTS=$((TOTAL_POINTS + A11Y_POINTS))
MAX_POINTS=$((MAX_POINTS + 10))
echo "üìä Accessibility Score: $A11Y_POINTS/10"

# Final Score Calculation
echo ""
echo "üèÜ FINAL 100% MOBILE SCORE RESULTS"
echo "=================================="

FINAL_SCORE=$(( (TOTAL_POINTS * 100) / MAX_POINTS ))

echo "üìä Component Breakdown:"
echo "   üåê Infrastructure: $INFRA_POINTS/10"
echo "   üì± Mobile Design: $DESIGN_POINTS/15"
echo "   üß© Components: $COMPONENT_POINTS/20"
echo "   üõ†Ô∏è Premium Utils: $UTILS_POINTS/15"
echo "   üåê API Integration: $API_POINTS/10"
echo "   üîß Build Quality: $BUILD_POINTS/10"
echo "   üéØ Advanced Features: $ADVANCED_POINTS/10"
echo "   ‚ôø Accessibility: $A11Y_POINTS/10"

echo ""
echo "üéØ TOTAL SCORE: $FINAL_SCORE% ($TOTAL_POINTS/$MAX_POINTS points)"

if [ $FINAL_SCORE -eq 100 ]; then
    echo "üèÜ PERFECT 100% MOBILE SCORE ACHIEVED!"
    echo "üéâ Premium mobile experience with all features!"
    echo "‚≠ê Excellence in mobile development!"
elif [ $FINAL_SCORE -ge 95 ]; then
    echo "ü•á EXCELLENT! Almost perfect mobile score!"
    echo "üíé Premium mobile experience!"
elif [ $FINAL_SCORE -ge 90 ]; then
    echo "ü•à OUTSTANDING mobile implementation!"
    echo "üëë High-quality mobile experience!"
elif [ $FINAL_SCORE -ge 80 ]; then
    echo "ü•â GREAT mobile score!"
    echo "üëç Solid mobile implementation!"
elif [ $FINAL_SCORE -ge 70 ]; then
    echo "‚úÖ GOOD mobile score with room for improvement"
    echo "üìà On track for excellence!"
else
    echo "‚ö†Ô∏è Mobile implementation needs improvement"
    echo "üí™ Keep working toward 100%!"
fi

echo ""
echo "üí° RECOMMENDATIONS FOR 100%:"

if [ $INFRA_POINTS -lt 10 ]; then
    echo "   üåê Ensure both frontend and backend servers are running"
fi

if [ $DESIGN_POINTS -lt 15 ]; then
    echo "   üì± Add comprehensive mobile CSS and PWA features"
fi

if [ $COMPONENT_POINTS -lt 20 ]; then
    echo "   üß© Implement all advanced mobile components"
fi

if [ $UTILS_POINTS -lt 15 ]; then
    echo "   üõ†Ô∏è Add premium mobile utilities (gestures, device management, accessibility)"
fi

if [ $API_POINTS -lt 10 ]; then
    echo "   üåê Fix API endpoints and ensure proper responses"
fi

if [ $BUILD_POINTS -lt 10 ]; then
    echo "   üîß Fix build errors and optimize bundle"
fi

if [ $ADVANCED_POINTS -lt 10 ]; then
    echo "   üéØ Integrate advanced features and performance optimizations"
fi

if [ $A11Y_POINTS -lt 10 ]; then
    echo "   ‚ôø Implement comprehensive accessibility features"
fi

echo ""
echo "üöÄ Mobile experience ready for testing at: http://localhost:5173"
echo "üì± Test on mobile devices and use browser DevTools device simulation"
echo "üîß Add ?debug=mobile to URL for advanced debugging"

exit $((100 - FINAL_SCORE))
